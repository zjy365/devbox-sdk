openapi: 3.1.0
jsonSchemaDialect: "https://json-schema.org/draft/2020-12/schema"
info:
  title: DevBox SDK Server API
  description: |
    A comprehensive API for managing processes, sessions, files, and providing real-time monitoring capabilities.

    The DevBox SDK Server provides HTTP endpoints for:
    - **File Operations**: Read, write, delete, and list files with security constraints
    - **Process Management**: Execute processes synchronously or asynchronously with log monitoring
    - **Session Management**: Create and manage interactive shell sessions
    - **Real-time Communication**: WebSocket connections for live log streaming
    - **Health Monitoring**: Health check and readiness endpoints
    - **Port Monitoring**: Monitor listening ports on the system

    ## Configuration
    Server configuration via environment variables or CLI flags:

    | Variable | Default | Description |
    |----------|---------|-------------|
    | `ADDR` | `0.0.0.0:9757` | Server listening address |
    | `WORKSPACE_PATH` | `/home/devbox/project` | Base workspace directory |
    | `MAX_FILE_SIZE` | `104857600` (100MB) | Maximum file size in bytes |
    | `TOKEN` | (auto-generated) | Authentication token |
    | `MAX_CONCURRENT_READS` | `CPU cores * 2` (1-32) | Concurrent file reads for search/replace |

    CLI flags override environment variables. Example:
    ```bash
    devbox-sdk-server --addr=0.0.0.0:8080 --max-concurrent-reads=16
    ```

    ## Authentication
    All API endpoints (except health checks) require Bearer token authentication:

    ```http
    Authorization: Bearer <your-token>
    ```

    ## Error Handling
    The API uses standard HTTP status codes and returns consistent error responses:

    ```json
    {
      "error": "Error description",
      "code": "ERROR_CODE",
      "timestamp": 1640995200000
    }
    ```

  version: 1.0.0
  contact:
    name: DevBox SDK Team
    url: https://github.com/labring/devbox-sdk
  license:
    name: Apache License 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

servers:
  - url: http://localhost:9757
    description: Development server (default port, configurable via ADDR env or -addr flag)
  - url: https://your-server.example.com
    description: Production server (replace with your actual server URL)

tags:
  - name: Health
    description: Health check and monitoring endpoints
  - name: Files
    description: File operations and management
  - name: Processes
    description: Process execution and management
  - name: Sessions
    description: Interactive shell session management
  - name: Ports
    description: Port monitoring and management
  - name: WebSocket
    description: Real-time communication and streaming

paths:
  /health:
    get:
      tags:
        - Health
      summary: Basic health check
      description: Returns basic server status including uptime and version information
      operationId: healthCheck
      responses:
        "200":
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              example:
                status: "healthy"
                timestamp: "2024-01-01T12:00:00Z"
                uptime: 3600
                version: "1.0.0"

  /health/ready:
    get:
      tags:
        - Health
      summary: Readiness check
      description: Performs readiness checks including filesystem write tests
      operationId: readinessCheck
      responses:
        "200":
          description: Server is ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadinessResponse"
              example:
                status: "ready"
                ready: true
                timestamp: "2024-01-01T12:00:00Z"
                checks:
                  filesystem: true
        "503":
          description: Server is not ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadinessResponse"
              example:
                status: "not_ready"
                ready: false
                timestamp: "2024-01-01T12:00:00Z"
                checks:
                  filesystem: false

  /api/v1/files/write:
    post:
      tags:
        - Files
      summary: Write file (Smart Routing)
      description: |
        Write content to a file with smart routing based on Content-Type header.

        **Supported Modes:**

        1. **JSON Mode** (`Content-Type: application/json`):
           - Plain text content: Set `content` field with string data
           - Base64 encoded: Set `content` field with base64 data and `encoding: "base64"`
           - Path specified in request body

        2. **Binary Mode** (any other Content-Type except multipart/form-data):
           - Direct binary upload with zero encoding overhead
           - Path specified via query parameter, custom header, or base64-encoded query
           - Suitable for large files, images, videos, etc.

        3. **Multipart Mode** (`Content-Type: multipart/form-data`):
           - Standard FormData upload (browser-compatible)
           - File sent via `file` or `files` field
           - Optional `path` form field to specify target path
           - If no path provided, uses uploaded filename

        **Path Sources:**
        - JSON mode: `path` field in JSON body
        - Binary mode (priority order):
          1. Query parameter: `?path=/tmp/file.png`
        - Multipart mode: `path` form field or defaults to uploaded filename
      security:
        - bearerAuth: []
      operationId: writeFile
      parameters:
        - name: path
          in: query
          description: File path (used in binary mode)
          required: false
          schema:
            type: string
            example: "/tmp/image.png"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WriteFileRequest"
            examples:
              plainText:
                summary: Plain text file
                value:
                  path: "/tmp/example.txt"
                  content: "Hello, World!"
              base64Image:
                summary: Base64-encoded image
                value:
                  path: "/tmp/image.png"
                  content: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
                  encoding: "base64"
          application/octet-stream:
            schema:
              type: string
              format: binary
            description: Raw binary data for direct upload
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: The file to upload (use 'file' or 'files' field name)
                path:
                  type: string
                  description: Optional target path. If not provided, uses uploaded filename
              required:
                - file
            encoding:
              file:
                contentType: application/octet-stream, image/*, video/*, application/pdf
            examples:
              singleFile:
                summary: Upload single file with custom path
                value:
                  file: "[binary file data]"
                  path: "/tmp/uploaded_file.txt"
              defaultFilename:
                summary: Upload file using original filename
                value:
                  file: "[binary file data]"
      responses:
        "200":
          description: File written successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WriteFileResponse"
              example:
                success: true
                path: "/tmp/image.png"
                size: 2048576
                timestamp: "2025-11-11T10:30:00Z"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "413":
          description: File size exceeds limit
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                error: "File size exceeds maximum allowed size of 104857600 bytes"
                error_type: "invalid_request"

  /api/v1/files/read:
    get:
      tags:
        - Files
      summary: Read file (returns binary content)
      description: Read file content and return as binary stream with appropriate Content-Type
      security:
        - bearerAuth: []
      operationId: readFile
      parameters:
        - name: path
          in: query
          description: File path to read
          required: true
          schema:
            type: string
            example: "/tmp/example.txt"
      responses:
        "200":
          description: File read successfully (binary content)
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
            text/plain:
              schema:
                type: string
            image/*:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
              description: Attachment filename
            Content-Length:
              schema:
                type: integer
              description: File size in bytes
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: File not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/files/delete:
    post:
      tags:
        - Files
      summary: Delete file or directory
      description: Delete files or directories with optional recursive deletion
      security:
        - bearerAuth: []
      operationId: deleteFile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DeleteFileRequest"
            example:
              path: "/tmp/example.txt"
              recursive: false
      responses:
        "200":
          description: File deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteFileResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: File not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/files/move:
    post:
      tags:
        - Files
      summary: Move file or directory
      description: Move a file or directory from source to destination with optional overwrite
      security:
        - bearerAuth: []
      operationId: moveFile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MoveFileRequest"
            example:
              source: "/home/devbox/project/old/file.txt"
              destination: "/home/devbox/project/new/file.txt"
              overwrite: false
      responses:
        "200":
          description: File moved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MoveFileResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Source file not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Destination already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/files/rename:
    post:
      tags:
        - Files
      summary: Rename file or directory
      description: Rename a file or directory from old path to new path
      security:
        - bearerAuth: []
      operationId: renameFile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RenameFileRequest"
            example:
              oldPath: "/home/devbox/project/oldname.txt"
              newPath: "/home/devbox/project/newname.txt"
      responses:
        "200":
          description: File renamed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RenameFileResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Old path not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: New path already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/files/chmod:
    post:
      tags:
        - Files
      summary: Change file or directory permissions
      description: Change permissions of a file or directory. Supports recursive updates on Unix-like systems.
      security:
        - bearerAuth: []
      operationId: chmod
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChmodRequest"
            example:
              path: "/home/devbox/project/script.sh"
              mode: "0755"
              recursive: false
      responses:
        "200":
          description: Permissions updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChmodResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/files/download:
    get:
      tags:
        - Files
      summary: Download a single file
      description: |
        Download a single file as binary content with appropriate Content-Type and Content-Disposition headers.

        This endpoint is for downloading individual files. For multiple files, use `/api/v1/files/batch-download`.
      security:
        - bearerAuth: []
      operationId: downloadFile
      parameters:
        - name: path
          in: query
          description: File path to download
          required: true
          schema:
            type: string
            example: "/tmp/example.txt"
      responses:
        "200":
          description: File downloaded successfully
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
            text/plain:
              schema:
                type: string
            image/*:
              schema:
                type: string
                format: binary
            application/pdf:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
              description: Attachment with filename
            Content-Length:
              schema:
                type: integer
              description: File size in bytes
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: File not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/files/batch-download:
    post:
      tags:
        - Files
      summary: Download multiple files with smart format detection
      description: |
        Download one or multiple files with intelligent format selection:

        **Format Selection Priority:**
        1. JSON body `format` field
        2. `Accept` header detection
        3. Default to `tar.gz`

        **Supported Formats:**
        - `tar.gz`: Compressed tar archive (default)
        - `tar`: Uncompressed tar archive (no gzip command needed on client)
        - `multipart` or `mixed`: HTTP multipart/mixed format (native HTTP, no extraction tools needed)

        **Accept Header Examples:**
        - `Accept: application/gzip` → tar.gz
        - `Accept: application/x-tar` → tar (no compression)
        - `Accept: multipart/mixed` → multipart format
        - No Accept header → tar.gz (default)
      security:
        - bearerAuth: []
      operationId: batchDownloadFiles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DownloadFilesRequest"
            examples:
              single_file:
                summary: Download single file
                value:
                  paths: ["/home/devbox/project/file.txt"]
              multiple_files_default:
                summary: Download multiple files (default tar.gz)
                value:
                  paths:
                    [
                      "/home/devbox/project/file1.txt",
                      "/home/devbox/project/file2.txt",
                    ]
              multiple_files_tar:
                summary: Download as uncompressed tar
                value:
                  paths:
                    [
                      "/home/devbox/project/file1.txt",
                      "/home/devbox/project/file2.txt",
                    ]
                  format: "tar"
              multiple_files_multipart:
                summary: Download as multipart
                value:
                  paths:
                    [
                      "/home/devbox/project/file1.txt",
                      "/home/devbox/project/file2.txt",
                    ]
                  format: "multipart"
      responses:
        "200":
          description: File(s) downloaded successfully
          content:
            application/gzip:
              schema:
                type: string
                format: binary
                description: tar.gz archive (compressed)
            application/x-tar:
              schema:
                type: string
                format: binary
                description: tar archive (uncompressed)
            multipart/mixed:
              schema:
                type: string
                format: binary
                description: HTTP multipart format (native, no extraction needed)
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: File not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/files/batch-upload:
    post:
      tags:
        - Files
      summary: Batch upload files
      description: Upload multiple files; each file's filename can be an absolute or relative Linux path. Relative paths are resolved under the workspace.
      security:
        - bearerAuth: []
      operationId: batchUpload
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                files:
                  type: array
                  items:
                    type: string
                    format: binary
                  description: Files to upload; filename carries desired path
              required:
                - files
      responses:
        "200":
          description: Files uploaded successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchUploadResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/files/list:
    get:
      tags:
        - Files
      summary: List directory contents
      description: List files and directories with pagination and filtering options
      security:
        - bearerAuth: []
      operationId: listFiles
      parameters:
        - name: path
          in: query
          description: "Directory path to list (default: current directory)"
          required: false
          schema:
            type: string
            default: "."
        - name: showHidden
          in: query
          description: Show hidden files (starting with .)
          required: false
          schema:
            type: boolean
            default: false
        - name: limit
          in: query
          description: Maximum number of items to return
          required: false
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
        - name: offset
          in: query
          description: Number of items to skip for pagination
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        "200":
          description: Directory listing successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListFilesResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Directory not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/process/list:
    get:
      tags:
        - Processes
      summary: List all processes
      description: Get a list of all running processes with their metadata
      security:
        - bearerAuth: []
      operationId: listProcesses
      responses:
        "200":
          description: Process list retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListProcessesResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/process/exec:
    post:
      tags:
        - Processes
      summary: Execute process asynchronously
      description: Execute a new process asynchronously and return immediately with process ID
      security:
        - bearerAuth: []
      operationId: execProcess
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProcessExecRequest"
            example:
              command: "ls"
              args: ["-la", "/tmp"]
              cwd: "/home/user"
              env:
                PATH: "/usr/bin:/bin"
                DEBUG: "true"
              timeout: 300
      responses:
        "200":
          description: Process started successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProcessExecResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          description: Failed to start process
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/process/exec-sync:
    post:
      tags:
        - Processes
      summary: Execute process synchronously
      description: Execute a process and wait for completion with timeout support
      security:
        - bearerAuth: []
      operationId: execProcessSync
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SyncExecutionRequest"
            example:
              command: "echo"
              args: ["Hello World"]
              timeout: 30
      responses:
        "200":
          description: Process completed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyncExecutionResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "408":
          description: Process execution timeout
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/process/sync-stream:
    post:
      tags:
        - Processes
      summary: Execute process with streaming
      description: Execute a process synchronously with Server-Sent Events streaming for real-time output
      security:
        - bearerAuth: []
      operationId: execProcessSyncStream
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SyncExecutionRequest"
      responses:
        "200":
          description: Process streaming started
          content:
            text/event-stream:
              schema:
                type: string
                description: Server-Sent Events stream with process output
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/process/{id}/status:
    get:
      tags:
        - Processes
      summary: Get process status
      description: Get the current status of a specific process
      security:
        - bearerAuth: []
      operationId: getProcessStatus
      parameters:
        - name: id
          in: path
          description: Process ID
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Process status retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetProcessStatusResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Process not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/files/search:
    post:
      tags:
        - Files
      summary: Search files by filename
      description: |
        Recursively search for files by filename pattern (case-insensitive substring match).

        - Results are unordered and may return as soon as files match
        - Only searches filenames, does not read file contents
        - Binary and text files are both included
      security:
        - bearerAuth: []
      operationId: searchFiles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SearchFilenameRequest"
      responses:
        "200":
          description: Search completed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Directory not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/files/find:
    post:
      tags:
        - Files
      summary: Find files by content
      description: |
        Recursively search for a keyword inside file contents.

        - Results are unordered and may return as soon as files match
        - Binary files are detected via header sniffing and skipped
        - Only searches in text files (UTF-8 validated)
      security:
        - bearerAuth: []
      operationId: findInFiles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FindRequest"
      responses:
        "200":
          description: Find completed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FindResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Directory not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/files/replace:
    post:
      tags:
        - Files
      summary: Replace in files
      description: |
        Replace a string with another string in multiple files.

        **Encoding Limitation:**
        - Only UTF-8 encoded text files are supported
        - Files with other encodings (GBK, UTF-16, Latin1, etc.) will return status "skipped" with error "Non-UTF-8 text file"
        - Binary files are automatically detected and skipped
      security:
        - bearerAuth: []
      operationId: replaceInFiles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReplaceRequest"
      responses:
        "200":
          description: Replacement completed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReplaceResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
  /api/v1/process/{id}/kill:
    post:
      tags:
        - Processes
      summary: Kill process
      description: Terminate a running process with optional signal specification
      security:
        - bearerAuth: []
      operationId: killProcess
      parameters:
        - name: id
          in: path
          description: Process ID
          required: true
          schema:
            type: string
        - name: signal
          in: query
          description: "Signal to send (default: SIGTERM)"
          required: false
          schema:
            type: string
            enum: [SIGTERM, SIGKILL, SIGINT]
            default: "SIGTERM"
      responses:
        "200":
          description: Process terminated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Process not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Process is not running
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/process/{id}/logs:
    get:
      tags:
        - Processes
      summary: Get process logs
      description: Retrieve logs for a specific process with optional streaming
      security:
        - bearerAuth: []
      operationId: getProcessLogs
      parameters:
        - name: id
          in: path
          description: Process ID
          required: true
          schema:
            type: string
        - name: stream
          in: query
          description: Enable log streaming
          required: false
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: Process logs retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetProcessLogsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Process not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/sessions:
    get:
      tags:
        - Sessions
      summary: List all sessions
      description: Get a list of all active sessions
      security:
        - bearerAuth: []
      operationId: getAllSessions
      responses:
        "200":
          description: Sessions list retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetAllSessionsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/sessions/create:
    post:
      tags:
        - Sessions
      summary: Create session
      description: Create a new interactive shell session
      security:
        - bearerAuth: []
      operationId: createSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSessionRequest"
            example:
              workingDir: "/home/user"
              env:
                PATH: "/usr/bin:/bin"
                DEBUG: "true"
              shell: "/bin/bash"
      responses:
        "200":
          description: Session created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateSessionResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/sessions/{id}:
    get:
      tags:
        - Sessions
      summary: Get session info
      description: Get information about a specific session
      security:
        - bearerAuth: []
      operationId: getSession
      parameters:
        - name: id
          in: path
          description: Session ID
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Session information retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetSessionResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/sessions/{id}/env:
    post:
      tags:
        - Sessions
      summary: Update session environment
      description: Update environment variables for a session
      security:
        - bearerAuth: []
      operationId: updateSessionEnv
      parameters:
        - name: id
          in: path
          description: Session ID
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateSessionEnvRequest"
            example:
              env:
                PATH: "/usr/bin:/bin:/usr/local/bin"
                DEBUG: "true"
                NEW_VAR: "value"
      responses:
        "200":
          description: Environment updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/sessions/{id}/exec:
    post:
      tags:
        - Sessions
      summary: Execute command in session
      description: Execute a command in an active session
      security:
        - bearerAuth: []
      operationId: sessionExec
      parameters:
        - name: id
          in: path
          description: Session ID
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SessionExecRequest"
            example:
              command: "ls -la"
      responses:
        "200":
          description: Command executed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionExecResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/sessions/{id}/cd:
    post:
      tags:
        - Sessions
      summary: Change directory in session
      description: Change the working directory in a session
      security:
        - bearerAuth: []
      operationId: sessionCd
      parameters:
        - name: id
          in: path
          description: Session ID
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SessionCdRequest"
            example:
              path: "/tmp"
      responses:
        "200":
          description: Directory changed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionCdResponse"
              example:
                success: true
                workingDir: "/tmp"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/sessions/{id}/terminate:
    post:
      tags:
        - Sessions
      summary: Terminate session
      description: Terminate an active session
      security:
        - bearerAuth: []
      operationId: terminateSession
      parameters:
        - name: id
          in: path
          description: Session ID
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Session terminated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/sessions/{id}/logs:
    get:
      tags:
        - Sessions
      summary: Get session logs
      description: Retrieve logs for a specific session with filtering options
      security:
        - bearerAuth: []
      operationId: getSessionLogs
      parameters:
        - name: id
          in: path
          description: Session ID
          required: true
          schema:
            type: string
        - name: levels
          in: query
          description: Log levels to filter
          required: false
          schema:
            type: array
            items:
              type: string
              enum: [stdout, stderr, system]
        - name: limit
          in: query
          description: Maximum number of log entries
          required: false
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
      responses:
        "200":
          description: Session logs retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetSessionLogsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/ports:
    get:
      tags:
        - Ports
      summary: Get listening ports
      description: |
        Returns TCP ports currently listening on 0.0.0.0 or * (all interfaces).

        **Security:** Only returns ports in the range 3000-9999 to exclude privileged ports and system services.
      security:
        - bearerAuth: []
      operationId: getPorts
      responses:
        "200":
          description: List of listening ports (filtered to 3000-9999 range)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PortsResponse"
              example:
                success: true
                ports: [3000, 8080, 9757]
                lastUpdatedAt: 1699999999
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /ws:
    get:
      tags:
        - WebSocket
      summary: WebSocket connection
      description: |
        Establish a WebSocket connection for real-time log streaming and subscriptions.

        The WebSocket supports JSON-based protocol with the following message types:

        **Subscription Request:**
        ```json
        {
          "action": "subscribe",
          "type": "process|session",
          "targetId": "process-or-session-id",
          "options": {
            "levels": ["stdout", "stderr"],
            "tail": 100,
            "follow": true,
            "startTime": 1640995200000
          }
        }
        ```

        **Log Message:**
        ```json
        {
          "type": "log",
          "dataType": "process|session",
          "targetId": "target-id",
          "log": {
            "level": "stdout",
            "content": "output content",
            "timestamp": 1640995200000,
            "sequence": 1
          },
          "sequence": 1,
          "isHistory": false
        }
        ```
      security:
        - bearerAuth: []
      operationId: webSocket
      responses:
        "101":
          description: WebSocket connection established
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # Common Schemas
    Response:
      type: object
      properties:
        status:
          type: integer
          description: Status code (0 for success)
          example: 0
        message:
          type: string
          description: Status message
          example: "success"
      required:
        - status
        - message

    ErrorResponse:
      type: object
      properties:
        status:
          type: integer
          description: Error status code
        message:
          type: string
          description: Error message
        data:
          type: object
          description: Additional error data
      required:
        - status
        - message

    SuccessResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          example:
            status: 0
            message: "success"

    # Health Schemas
    HealthResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            healthStatus:
              type: string
              example: "ok"
            uptime:
              type: string
              description: Server uptime
              example: "3600s"
            version:
              type: string
              example: "1.0.0"
          required:
            - healthStatus
            - uptime
            - version

    ReadinessResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            readinessStatus:
              type: string
              example: "ready"
            workspace:
              type: boolean
              description: Whether workspace is accessible
              example: true
          required:
            - readinessStatus
            - workspace

    # File Schemas
    WriteFileRequest:
      type: object
      properties:
        path:
          type: string
          description: File path to write to
          example: "/tmp/example.txt"
        content:
          type: string
          description: File content
          example: "Hello, World!"
        encoding:
          type: string
          description: Content encoding
          example: "utf-8"
        permissions:
          type: string
          description: File permissions in octal format
          example: "0644"
      required:
        - path
        - content

    WriteFileResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            path:
              type: string
              description: File path that was written
              example: "/tmp/example.txt"
            size:
              type: integer
              format: int64
              description: File size in bytes
              example: 13
          required:
            - path
            - size

    DeleteFileRequest:
      type: object
      properties:
        path:
          type: string
          description: File or directory path to delete
          example: "/tmp/example.txt"
        recursive:
          type: boolean
          description: Whether to delete directories recursively
          default: false
          example: false
      required:
        - path

    DeleteFileResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            success:
              type: boolean
              example: true
          required:
            - success

    MoveFileRequest:
      type: object
      properties:
        source:
          type: string
          description: Source file or directory path
          example: "/home/devbox/project/old/file.txt"
        destination:
          type: string
          description: Destination file or directory path
          example: "/home/devbox/project/new/file.txt"
        overwrite:
          type: boolean
          description: Whether to overwrite existing destination
          default: false
          example: false
      required:
        - source
        - destination

    MoveFileResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            success:
              type: boolean
              example: true
          required:
            - success

    RenameFileRequest:
      type: object
      properties:
        oldPath:
          type: string
          description: Current file or directory path
          example: "/home/devbox/project/oldname.txt"
        newPath:
          type: string
          description: New file or directory path
          example: "/home/devbox/project/newname.txt"
      required:
        - oldPath
        - newPath

    RenameFileResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            success:
              type: boolean
              example: true
          required:
            - success

    ChmodRequest:
      type: object
      properties:
        path:
          type: string
          description: File or directory path
          example: "/home/devbox/project/script.sh"
        mode:
          type: string
          description: Octal permission (e.g., "755", "0755", or "0o755")
          example: "0755"
        owner:
          type: string
          description: Owner in the form "uid[:gid]" or "user[:group]" (Linux only)
          examples:
            numeric: "1000:1000"
            named: "devbox:devbox"
        recursive:
          type: boolean
          description: Recursively apply to directories and their contents
          default: false
          example: false
      required:
        - path
        - mode

    ChmodResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            success:
              type: boolean
              example: true
          required:
            - success

    DownloadFilesRequest:
      type: object
      properties:
        paths:
          type: array
          items:
            type: string
          description: List of file or directory paths to download
          minItems: 1
          example:
            ["/home/devbox/project/file1.txt", "/home/devbox/project/file2.txt"]
        format:
          type: string
          enum: [tar.gz, tar, multipart, mixed]
          description: |
            Optional download format. If not specified, format is auto-detected from Accept header or defaults to tar.gz:
            - `tar.gz`: Compressed tar archive (default)
            - `tar`: Uncompressed tar archive (use when client doesn't have gzip)
            - `multipart` or `mixed`: HTTP multipart/mixed format (no extraction tools needed)
          example: "tar.gz"
      required:
        - paths

    FileInfo:
      type: object
      properties:
        name:
          type: string
          description: File or directory name
          example: "example.txt"
        path:
          type: string
          description: Full path
          example: "/tmp/example.txt"
        size:
          type: integer
          format: int64
          description: Size in bytes
          example: 1024
        isDir:
          type: boolean
          description: Whether this is a directory
          example: false
        mimeType:
          type: string
          description: Best-effort MIME type
          example: "text/plain"
        permissions:
          type: string
          description: File permissions in octal format
          example: "0644"
        modified:
          type: string
          format: date-time
          description: Last modification time
          example: "2024-01-01T12:00:00Z"
      required:
        - name
        - path
        - size
        - isDir

    ListFilesResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            files:
              type: array
              items:
                $ref: "#/components/schemas/FileInfo"
          required:
            - files

    BatchUploadResult:
      type: object
      properties:
        path:
          type: string
        success:
          type: boolean
        error:
          type: string
        size:
          type: integer
          format: int64

    BatchUploadResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            results:
              type: array
              items:
                $ref: "#/components/schemas/BatchUploadResult"
            totalFiles:
              type: integer
            successCount:
              type: integer
          required:
            - results
            - totalFiles
            - successCount

    # File Search Schemas
    SearchFilenameRequest:
      type: object
      properties:
        dir:
          type: string
          description: Directory to search in
          example: "/tmp"
        pattern:
          type: string
          description: Filename pattern to search for (case-insensitive substring)
          example: "config"
      required:
        - dir
        - pattern

    SearchResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            files:
              type: array
              description: Unordered list of files matching the filename pattern
              items:
                type: string
          required:
            - files

    FindRequest:
      type: object
      properties:
        dir:
          type: string
          description: Directory to search in
          example: "/tmp"
        keyword:
          type: string
          description: Keyword to search for in file contents
          example: "TODO"
      required:
        - dir
        - keyword

    FindResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            files:
              type: array
              description: Unordered list of files containing the keyword
              items:
                type: string
          required:
            - files

    ReplaceRequest:
      type: object
      description: |
        Replace text in multiple files.

        **Encoding Limitation:**
        - Only UTF-8 encoded files are supported
        - Both `from` and `to` strings are transmitted as UTF-8 via HTTP/JSON
        - Files with other encodings (GBK, UTF-16, Latin1, etc.) will be skipped with status "skipped"
        - Binary files are automatically detected and skipped
      properties:
        files:
          type: array
          items:
            type: string
          description: List of files to perform replacement in
          example: ["/tmp/file1.txt", "/tmp/file2.txt"]
        from:
          type: string
          description: String to replace (UTF-8)
          example: "old_value"
        to:
          type: string
          description: Replacement string (UTF-8)
          example: "new_value"
      required:
        - files
        - from
        - to

    ReplaceResult:
      type: object
      properties:
        file:
          type: string
          description: File path
          example: "/tmp/file1.txt"
        status:
          type: string
          description: Operation status (success, error, skipped)
          enum: [success, error, skipped]
          example: "success"
        replacements:
          type: integer
          description: Number of replacements made
          example: 3
        error:
          type: string
          description: Error message if failed
      required:
        - file
        - status
        - replacements

    ReplaceResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            results:
              type: array
              items:
                $ref: "#/components/schemas/ReplaceResult"
          required:
            - results
    ProcessExecRequest:
      type: object
      properties:
        command:
          type: string
          description: Command to execute
          example: "ls"
        args:
          type: array
          items:
            type: string
          description: Command arguments
          example: ["-la", "/tmp"]
        cwd:
          type: string
          description: Working directory
          example: "/home/user"
        env:
          type: object
          additionalProperties:
            type: string
          description: Environment variables
          example:
            PATH: "/usr/bin:/bin"
            DEBUG: "true"
        shell:
          type: string
          description: Shell to use for execution
          example: "/bin/bash"
        timeout:
          type: integer
          description: Timeout in seconds
          example: 300
      required:
        - command

    ProcessExecResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            processId:
              type: string
              description: Generated process ID
              example: "550e8400-e29b-41d4-a716-446655440000"
            pid:
              type: integer
              description: System process ID
              example: 12345
            processStatus:
              type: string
              description: Process status
              example: "running"
      required:
        - processId
        - processStatus

    SyncExecutionRequest:
      type: object
      properties:
        command:
          type: string
          description: Command to execute
          example: "echo"
        args:
          type: array
          items:
            type: string
          description: Command arguments
          example: ["Hello World"]
        cwd:
          type: string
          description: Working directory
          example: "/home/user"
        env:
          type: object
          additionalProperties:
            type: string
          description: Environment variables
          example:
            PATH: "/usr/bin:/bin"
        shell:
          type: string
          description: Shell to use for execution
          example: "/bin/bash"
        timeout:
          type: integer
          description: Timeout in seconds
          example: 30
      required:
        - command

    SyncExecutionResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            stdout:
              type: string
              description: Standard output
              example: "Hello World\n"
            stderr:
              type: string
              description: Standard error
              example: ""
            exitCode:
              type: integer
              description: Process exit code
              example: 0
            durationMs:
              type: integer
              format: int64
              description: Execution duration in milliseconds
              example: 150
            startTime:
              type: integer
              format: int64
              description: Start timestamp (Unix)
              example: 1640995200
            endTime:
              type: integer
              format: int64
              description: End timestamp (Unix)
              example: 1640995201
      required:
        - stdout
        - stderr
        - durationMs
        - startTime
        - endTime

    ProcessInfoResponse:
      type: object
      properties:
        processId:
          type: string
          description: Process ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        pid:
          type: integer
          description: System process ID
          example: 12345
        command:
          type: string
          description: Command that was executed
          example: "ls"
        processStatus:
          type: string
          description: Current process status
          example: "running"
        startTime:
          type: integer
          format: int64
          description: Start timestamp (Unix)
          example: 1640995200
        endTime:
          type: integer
          format: int64
          description: End timestamp (Unix)
          example: 1640995260
        exitCode:
          type: integer
          description: Process exit code
          example: 0
      required:
        - processId
        - pid
        - command
        - processStatus
        - startTime

    ListProcessesResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            processes:
              type: array
              items:
                $ref: "#/components/schemas/ProcessInfoResponse"
      required:
        - processes

    GetProcessStatusResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            processId:
              type: string
              description: Process ID
              example: "550e8400-e29b-41d4-a716-446655440000"
            pid:
              type: integer
              description: System process ID
              example: 12345
            processStatus:
              type: string
              description: Process status
              example: "running"
            startTime:
              type: integer
              format: int64
              description: Process start time (Unix timestamp)
              example: 1699999999
            endTime:
              type: integer
              format: int64
              description: Process end time (Unix timestamp)
            exitCode:
              type: integer
              description: Process exit code
            command:
              type: string
              description: Command executed
      required:
        - processId
        - pid
        - processStatus
        - startTime
        - command

    GetProcessLogsResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            processId:
              type: string
              description: Process ID
              example: "550e8400-e29b-41d4-a716-446655440000"
            pid:
              type: integer
              description: System process ID
            processStatus:
              type: string
              description: Process status
            exitCode:
              type: integer
              description: Exit code
            logs:
              type: array
              items:
                type: string
              description: Process log lines
              example: ["output line 1", "output line 2"]
      required:
        - processId
        - logs

    # Session Schemas
    CreateSessionRequest:
      type: object
      properties:
        workingDir:
          type: string
          description: Initial working directory
          example: "/home/user"
        env:
          type: object
          additionalProperties:
            type: string
          description: Initial environment variables
          example:
            PATH: "/usr/bin:/bin"
            DEBUG: "true"
        shell:
          type: string
          description: Shell type to use
          example: "/bin/bash"
      required:
        - shell

    CreateSessionResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            sessionId:
              type: string
              description: Generated session ID
              example: "550e8400-e29b-41d4-a716-446655440000"
            shell:
              type: string
              description: Shell type being used
              example: "/bin/bash"
            cwd:
              type: string
              description: Current working directory
              example: "/home/user"
            sessionStatus:
              type: string
              description: Session status
              enum: [active, terminated]
              example: "active"
      required:
        - sessionId
        - shell
        - cwd
        - sessionStatus

    SessionInfo:
      type: object
      description: Detailed session information with RFC3339 formatted timestamps (used for GetSession endpoint)
      properties:
        sessionId:
          type: string
          description: Session ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        shell:
          type: string
          description: Shell type
          example: "/bin/bash"
        cwd:
          type: string
          description: Current working directory
          example: "/home/user"
        env:
          type: object
          additionalProperties:
            type: string
          description: Environment variables
          example:
            PATH: "/usr/bin:/bin"
            DEBUG: "true"
        sessionStatus:
          type: string
          description: Session status
          enum: [active, terminated]
          example: "active"
        createdAt:
          type: string
          format: date-time
          description: Session creation time
          example: "2024-01-01T12:00:00Z"
        lastUsedAt:
          type: string
          format: date-time
          description: Last activity time
          example: "2024-01-01T12:05:00Z"
      required:
        - sessionId
        - shell
        - cwd
        - sessionStatus
        - createdAt
        - lastUsedAt

    SessionResponse:
      type: object
      description: Session information
      properties:
        sessionId:
          type: string
          description: Session ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        shell:
          type: string
          description: Shell type
          example: "/bin/bash"
        cwd:
          type: string
          description: Current working directory
          example: "/home/user"
        env:
          type: object
          additionalProperties:
            type: string
          description: Environment variables
          example:
            PATH: "/usr/bin:/bin"
            DEBUG: "true"
        sessionStatus:
          type: string
          description: Session status
          enum: [active, terminated]
          example: "active"
        createdAt:
          type: string
          format: date-time
          description: Session creation time
          example: "2024-01-01T12:00:00Z"
        lastUsedAt:
          type: string
          format: date-time
          description: Last activity time
          example: "2024-01-01T12:05:00Z"
      required:
        - sessionId
        - shell
        - cwd
        - sessionStatus
        - createdAt
        - lastUsedAt

    GetAllSessionsResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            sessions:
              type: array
              items:
                $ref: "#/components/schemas/SessionResponse"
      required:
        - sessions

    GetSessionResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            sessionId:
              type: string
              description: Session ID
              example: "550e8400-e29b-41d4-a716-446655440000"
            shell:
              type: string
              description: Shell type
              example: "/bin/bash"
            cwd:
              type: string
              description: Current working directory
              example: "/home/user"
            env:
              type: object
              additionalProperties:
                type: string
              description: Environment variables
              example:
                PATH: "/usr/bin:/bin"
                DEBUG: "true"
            sessionStatus:
              type: string
              description: Session status
              enum: [active, terminated]
              example: "active"
            createdAt:
              type: string
              format: date-time
              description: Session creation time
              example: "2024-01-01T12:00:00Z"
            lastUsedAt:
              type: string
              format: date-time
              description: Last activity time
              example: "2024-01-01T12:05:00Z"
      required:
        - sessionId
        - shell
        - cwd
        - sessionStatus
        - createdAt
        - lastUsedAt

    UpdateSessionEnvRequest:
      type: object
      properties:
        env:
          type: object
          additionalProperties:
            type: string
          description: Environment variables to set or update
          example:
            PATH: "/usr/bin:/bin:/usr/local/bin"
            DEBUG: "true"
            NEW_VAR: "value"
      required:
        - env

    SessionExecRequest:
      type: object
      properties:
        command:
          type: string
          description: Command to execute in session
          example: "ls -la"
      required:
        - command

    SessionExecResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            exitCode:
              type: integer
              description: Command exit code
              example: 0
            stdout:
              type: string
              description: Command output (standard output)
              example: ""
            stderr:
              type: string
              description: Error output (standard error)
              example: ""
            duration:
              type: integer
              format: int64
              description: Execution duration in milliseconds
              example: 0
      required:
        - exitCode
        - stdout
        - stderr
        - duration

    SessionCdRequest:
      type: object
      properties:
        path:
          type: string
          description: Directory path to change to
          example: "/tmp"
      required:
        - path

    SessionCdResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            workingDir:
              type: string
              description: New working directory
              example: "/tmp"
      required:
        - workingDir

    GetSessionLogsResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            sessionId:
              type: string
              description: Session ID
              example: "550e8400-e29b-41d4-a716-446655440000"
            logs:
              type: array
              items:
                type: string
              description: Session log lines (plain text format)
              example:
                ["[1640995200] stdout: line 1", "[1640995201] stderr: error"]
      required:
        - sessionId
        - logs

    PortsResponse:
      allOf:
        - $ref: "#/components/schemas/Response"
        - type: object
          properties:
            ports:
              type: array
              items:
                type: integer
                minimum: 3000
                maximum: 9999
              description: List of listening port numbers (filtered to 3000-9999 range for security)
              example: [3000, 8080, 9757]
            lastUpdatedAt:
              type: integer
              format: int64
              description: Unix timestamp of last port scan
              example: 1699999999
      required:
        - ports
        - lastUpdatedAt

    # WebSocket and Log Schemas
    LogEntry:
      type: object
      properties:
        level:
          type: string
          enum: ["stdout", "stderr", "system"]
          description: Log level
          example: "stdout"
        content:
          type: string
          description: Log content
          example: "Process output line"
        timestamp:
          type: integer
          format: int64
          description: Unix timestamp in milliseconds
          example: 1640995200000
        sequence:
          type: integer
          format: int64
          description: Sequence number
          example: 1
        source:
          type: string
          description: Log source
          example: "process"
        targetId:
          type: string
          description: Target process/session ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        targetType:
          type: string
          enum: ["process", "session"]
          description: Target type
          example: "process"
        message:
          type: string
          description: Additional message
          example: "Process started"
      required:
        - level
        - content
        - timestamp

    SubscriptionRequest:
      type: object
      properties:
        action:
          type: string
          enum: ["subscribe", "unsubscribe", "list"]
          description: Action to perform
          example: "subscribe"
        type:
          type: string
          enum: ["process", "session"]
          description: Subscription type
          example: "process"
        targetId:
          type: string
          description: Target process or session ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        options:
          $ref: "#/components/schemas/SubscriptionOptions"
      required:
        - action
        - type

    SubscriptionOptions:
      type: object
      properties:
        levels:
          type: array
          items:
            type: string
            enum: ["stdout", "stderr", "system"]
          description: Log levels to receive
          example: ["stdout", "stderr"]
        tail:
          type: integer
          description: Number of historical log entries to send
          example: 100
        follow:
          type: boolean
          description: Whether to follow new logs
          default: true
          example: true
        startTime:
          type: integer
          format: int64
          description: Start timestamp filter
          example: 1640995200000
      required:
        - tail

    LogMessage:
      type: object
      properties:
        type:
          type: string
          description: Message type
          example: "log"
        dataType:
          type: string
          enum: ["process", "session"]
          description: Data type
          example: "process"
        targetId:
          type: string
          description: Target ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        log:
          $ref: "#/components/schemas/LogEntry"
        sequence:
          type: integer
          description: Message sequence
          example: 1
        isHistory:
          type: boolean
          description: Whether this is a historical log entry
          default: false
          example: false
      required:
        - type
        - dataType
        - targetId
        - log
        - sequence

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "Invalid request parameters"
            code: "INVALID_REQUEST"
            timestamp: 1640995200000

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "Authentication required"
            code: "UNAUTHORIZED"
            timestamp: 1640995200000

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "Process not found"
            code: "NOT_FOUND"
            timestamp: 1640995200000

    Conflict:
      description: Resource conflict
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "Process is not running"
            code: "CONFLICT"
            timestamp: 1640995200000

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "Internal server error"
            code: "INTERNAL_ERROR"
            timestamp: 1640995200000
